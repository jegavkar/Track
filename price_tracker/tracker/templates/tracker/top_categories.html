{% extends 'tracker/base.html' %}

{% block title %}Top Categories{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-tags me-2 text-primary"></i>Top Categories</h1>
        <p class="lead text-muted">Discover popular product categories with the best deals</p>
    </div>
</div>

<div class="row">
    {% for category in categories %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card shadow-sm border-0 category-card h-100">
            
            <!-- Dynamic Header with icon + color -->
            <div class="card-header d-flex align-items-center fw-bold text-white 
                {% if category.name == 'Electronics' %} bg-primary
                {% elif category.name == 'Home & Kitchen' %} bg-success
                {% elif category.name == 'Clothing' %} bg-warning
                {% elif category.name == 'Books' %} bg-indigo
                {% elif category.name == 'Beauty & Personal Care' %} bg-pink
                {% else %} bg-primary {% endif %}">
                
                <i class="
                    {% if category.name == 'Electronics' %} fas fa-mobile-alt
                    {% elif category.name == 'Home & Kitchen' %} fas fa-utensils
                    {% elif category.name == 'Clothing' %} fas fa-tshirt
                    {% elif category.name == 'Books' %} fas fa-book
                    {% elif category.name == 'Beauty & Personal Care' %} fas fa-magic
                    {% else %} fas fa-tag {% endif %} me-2"></i>
                
                {{ category.name }}

                {% if category.deals %}
                    <span class="badge bg-warning text-dark ms-auto">{{ category.deals }}</span>
                {% endif %}
            </div>

            <div class="card-body">
                <h6 class="fw-bold text-dark">Popular Items</h6>
                <ul class="list-unstyled mt-2">
                    {% for item in category.popular_items %}
                    <li class="mb-2 d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i> {{ item }}
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="card-footer bg-light border-0 text-center">
                <button class="btn btn-outline-primary w-100 browse-btn" data-category="{{ category.name }}">
                    <i class="fas fa-arrow-right me-2"></i> Browse {{ category.name }}
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Section to display browse results -->
<div id="browse-results" class="mt-5" style="display: none;">
    <h2 id="results-title" class="mb-4"></h2>
    <div id="results-container" class="row"></div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.category-card {
    transition: all 0.3s ease-in-out;
    border-radius: 12px;
}
.category-card:hover {
    transform: translateY(-5px) scale(1.03);
    box-shadow: 0px 8px 24px rgba(0,0,0,0.12);
}
.browse-btn {
    transition: all 0.3s ease;
}
.browse-btn:hover {
    background-color: #2563EB;
    color: #fff;
}
.bg-indigo {
    background-color: #4F46E5 !important;
}
.bg-pink {
    background-color: #EC4899 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const browseButtons = document.querySelectorAll('.browse-btn');
    const resultsSection = document.getElementById('browse-results');
    const resultsTitle = document.getElementById('results-title');
    const resultsContainer = document.getElementById('results-container');

    browseButtons.forEach(button => {
        button.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            resultsTitle.textContent = `Browsing Amazon for ${category}`;
            resultsContainer.innerHTML = '<p>Loading...</p>';
            resultsSection.style.display = 'block';

            fetch(`/browse-category/${encodeURIComponent(category)}/`)
                .then(response => response.json())
                .then(data => {
                    resultsContainer.innerHTML = '';
                    if (data.products && data.products.length > 0) {
                        data.products.forEach(product => {
                            const col = document.createElement('div');
                            col.className = 'col-md-4 mb-4';

                            const card = document.createElement('div');
                            card.className = 'card h-100 shadow-sm border-0';

                            const img = document.createElement('img');
                            img.className = 'card-img-top';
                            img.src = product.image || 'https://via.placeholder.com/150';
                            img.alt = product.name;

                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body';

                            const title = document.createElement('h5');
                            title.className = 'card-title';
                            title.textContent = product.name;

                            const price = document.createElement('p');
                            price.className = 'card-text text-success fw-bold';
                            price.textContent = product.price ? `â‚¹${product.price}` : 'Price not available';

                            const link = document.createElement('a');
                            link.href = product.url;
                            link.target = '_blank';
                            link.className = 'btn btn-primary w-100';
                            link.textContent = 'View Deal';

                            cardBody.appendChild(title);
                            cardBody.appendChild(price);
                            cardBody.appendChild(link);

                            card.appendChild(img);
                            card.appendChild(cardBody);

                            col.appendChild(card);
                            resultsContainer.appendChild(col);
                        });
                    } else {
                        resultsContainer.innerHTML = '<p>No products found for this category.</p>';
                    }
                })
                .catch(error => {
                    resultsContainer.innerHTML = '<p>Error loading products. Please try again later.</p>';
                    console.error('Error fetching browse data:', error);
                });
        });
    });
});
</script>
{% endblock %}
